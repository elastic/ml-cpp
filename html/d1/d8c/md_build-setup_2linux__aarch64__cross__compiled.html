<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ML C++: Machine Learning Build Machine Setup for Linux aarch64 cross compiled</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript" src="../../darkmode_toggle.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../ml.ico"/></td>
  <td id="projectalign">
   <div id="projectname">ML C++<span id="projectnumber">&#160;8.15.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Machine Learning Build Machine Setup for Linux aarch64 cross compiled</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md24"></a> You will need the following environment variables to be defined:</p>
<ul>
<li><code>JAVA_HOME</code> - Should point to the JDK you want to use to run Gradle.</li>
<li><code>CPP_CROSS_COMPILE</code> - Should be set to "aarch64".</li>
<li><code>CPP_SRC_HOME</code> - Only required if building the C++ code directly using <code>cmake</code>, as Gradle sets it automatically.</li>
<li><code>PATH</code> - Must have <code>/usr/local/gcc103/bin</code> before <code>/usr/bin</code> and <code>/bin</code>.</li>
<li><code>LD_LIBRARY_PATH</code> - Must have <code>/usr/local/gcc103/lib64</code> and <code>/usr/local/gcc103/lib</code> before <code>/usr/lib</code> and <code>/lib</code>.</li>
</ul>
<p>For example, you might create a .bashrc file in your home directory containing this:</p>
<div class="fragment"><div class="line">umask 0002</div>
<div class="line">export JAVA_HOME=/usr/local/jdk1.8.0_121</div>
<div class="line">export LD_LIBRARY_PATH=/usr/local/gcc103/lib64:/usr/local/gcc103/lib:/usr/lib:/lib</div>
<div class="line">export PATH=$JAVA_HOME/bin:/usr/local/gcc103/bin:/usr/bin:/bin:/usr/sbin:/sbin</div>
<div class="line"># Only required if building the C++ code directly using cmake - adjust depending on the location of your Git clone</div>
<div class="line">export CPP_SRC_HOME=$HOME/ml-cpp</div>
<div class="line">export CPP_CROSS_COMPILE=aarch64</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md25"></a>
Initial Preparation</h2>
<p>Start by configuring a native Linux aarch64 build server as described in <a class="el" href="../../d6/d3a/md_build-setup_2linux.html">linux.md</a>.</p>
<p>The remainder of these instructions assume the native aarch64 build server you have configured is for CentOS 7. This is what builds for distribution are currently built on.</p>
<p>On the fully configured native aarch64 build server, run the following commands:</p>
<div class="fragment"><div class="line">cd /usr</div>
<div class="line">tar jcvf ~/usr-aarch64-linux-gnu.tar.bz2 include lib lib64 local</div>
</div><!-- fragment --><p>These instructions assume the host platform is also CentOS 7, but x86_64 instead of aarch64. It makes life much easier if the host distribution is the same as the target distribution.</p>
<p>Transfer the archive created in your home directory on the native aarch64 build server, <code>usr-aarch64-linux-gnu.tar.bz2</code>, to your home directory on the x86_64 host build server.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
OS Packages</h2>
<p>You need the C++ compiler and the headers for the <code>zlib</code> library that comes with the OS. You also need the archive utilities <code>unzip</code> and <code>bzip2</code>. On RHEL/CentOS these can be installed using:</p>
<div class="fragment"><div class="line">sudo yum install bzip2 gcc-c++ texinfo unzip zlib-devel</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md27"></a>
Transferred Build Dependencies</h2>
<p>Add the dependencies that you copied from the fully configured native aarch64 build server in the "Initial Preparation" step.</p>
<div class="fragment"><div class="line">sudo mkdir -p /usr/local/sysroot-aarch64-linux-gnu/usr</div>
<div class="line">cd /usr/local/sysroot-aarch64-linux-gnu/usr</div>
<div class="line">sudo tar jxvf ~/usr-aarch64-linux-gnu.tar.bz2</div>
<div class="line">cd ..</div>
<div class="line">sudo ln -s usr/lib lib</div>
<div class="line">sudo ln -s usr/lib64 lib64</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md28"></a>
General settings for building the tools</h2>
<p>Most of the tools are built via a GNU "configure" script. There are some environment variables that affect the behaviour of this. Therefore, when building ANY tool on Linux, set the following environment variables:</p>
<div class="fragment"><div class="line">export CFLAGS=&#39;-g -O3 -fstack-protector -D_FORTIFY_SOURCE=2 -msse4.2 -mfpmath=sse&#39;</div>
<div class="line">export CXXFLAGS=&#39;-g -O3 -fstack-protector -D_FORTIFY_SOURCE=2 -msse4.2 -mfpmath=sse&#39;</div>
<div class="line">export LDFLAGS=&#39;-Wl,-z,relro -Wl,-z,now&#39;</div>
<div class="line">export LDFLAGS_FOR_TARGET=&#39;-Wl,-z,relro -Wl,-z,now&#39;</div>
<div class="line">unset LIBRARY_PATH</div>
</div><!-- fragment --><p>These environment variables only need to be set when building tools on Linux. They should NOT be set when compiling the Machine Learning source code (as this should pick up all settings from our build system).</p>
<h2><a class="anchor" id="autotoc_md29"></a>
binutils (bootstrap version)</h2>
<p>Since we build with a more recent gcc than comes with the host system, we must build it from source. To build a cross compiler we need cross build tools, so we need to build versions that are compatible with the system compiler that we'll use to build the more recent gcc.</p>
<p>Download <code>binutils-2.25.tar.bz2</code> from <a href="http://ftpmirror.gnu.org/binutils/binutils-2.25.tar.bz2">http://ftpmirror.gnu.org/binutils/binutils-2.25.tar.bz2</a>.</p>
<p>Uncompress and untar the resulting file. Then run:</p>
<div class="fragment"><div class="line">unset LD_LIBRARY_PATH</div>
<div class="line">export PATH=/usr/bin:/bin:/usr/sbin:/sbin</div>
<div class="line">./configure --with-sysroot=/usr/local/sysroot-aarch64-linux-gnu --target=aarch64-linux-gnu --with-system-zlib --disable-multilib --disable-libstdcxx</div>
</div><!-- fragment --><p>This should build an appropriate Makefile. Assuming it does, type:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>to install.</p>
<h2><a class="anchor" id="autotoc_md30"></a>
gcc</h2>
<p>We have to build on old Linux versions to enable our software to run on the older versions of Linux that users have. However, this means the default compiler on our Linux build servers is also very old. To enable use of more modern C++ features, we use the default compiler to build a newer version of gcc and then use that to build all our other dependencies.</p>
<p>Download <code>gcc-10.3.0.tar.gz</code> from <a href="http://ftpmirror.gnu.org/gcc/gcc-10.3.0/gcc-10.3.0.tar.gz">http://ftpmirror.gnu.org/gcc/gcc-10.3.0/gcc-10.3.0.tar.gz</a>.</p>
<p>Unlike most automake-based tools, gcc must be built in a directory adjacent to the directory containing its source code, so build and install it like this:</p>
<div class="fragment"><div class="line">tar zxvf gcc-10.3.0.tar.gz</div>
<div class="line">cd gcc-10.3.0</div>
<div class="line">contrib/download_prerequisites</div>
<div class="line">sed -i -e &#39;s/$(SHLIB_LDFLAGS)/-Wl,-z,relro -Wl,-z,now $(SHLIB_LDFLAGS)/&#39; libgcc/config/t-slibgcc</div>
<div class="line">cd ..</div>
<div class="line">mkdir gcc-10.3.0-build</div>
<div class="line">cd gcc-10.3.0-build</div>
<div class="line">unset LD_LIBRARY_PATH</div>
<div class="line">export PATH=/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin</div>
<div class="line">../gcc-10.3.0/configure --prefix=/usr/local/gcc103 --with-sysroot=/usr/local/sysroot-aarch64-linux-gnu --target=aarch64-linux-gnu --enable-languages=c,c++ --enable-vtable-verify --with-system-zlib --disable-multilib</div>
<div class="line">make -j 6</div>
<div class="line">sudo env PATH=&quot;$PATH&quot; make install</div>
</div><!-- fragment --><p>(Note the <code>env PATH="$PATH"</code> bit in the install command - this is because the cross tools we put in <code>/usr/local/bin</code> are needed during the install.)</p>
<p>To confirm that everything works correctly run:</p>
<div class="fragment"><div class="line">aarch64-linux-gnu-g++ --version</div>
</div><!-- fragment --><p>It should print:</p>
<div class="fragment"><div class="line">aarch64-linux-gnu-g++ (GCC) 10.3.0</div>
</div><!-- fragment --><p>in the first line of the output. If it doesn't then double check that <code>/usr/local/gcc103/bin</code> is near the beginning of your <code>PATH</code>.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
binutils (final version)</h2>
<p>Also due to building on old Linux versions yet wanting to use modern libraries we have to install an up-to-date version of binutils. This will be used in preference to the bootstrap version by ensuring that <code>/usr/local/gcc103/bin</code> is at the beginning of <code>PATH</code>.</p>
<p>Download <code>binutils-2.37.tar.bz2</code> from <a href="http://ftpmirror.gnu.org/binutils/binutils-2.37.tar.bz2">http://ftpmirror.gnu.org/binutils/binutils-2.37.tar.bz2</a>.</p>
<p>Uncompress and untar the resulting file. Then run:</p>
<div class="fragment"><div class="line">./configure --prefix=/usr/local/gcc103 --with-sysroot=/usr/local/sysroot-aarch64-linux-gnu --target=aarch64-linux-gnu --enable-vtable-verify --with-system-zlib --disable-multilib --disable-libstdcxx --with-gcc-major-version-only</div>
</div><!-- fragment --><p>This should build an appropriate Makefile. Assuming it does, type:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>to install.</p>
<h2><a class="anchor" id="autotoc_md32"></a>
CMake</h2>
<p>CMake version 3.19.2 is the minimum required to build ml-cpp. Download version 3.23.2 from <a href="https://github.com/Kitware/CMake/releases/download/v3.23.2/cmake-3.23.2-Linux-x86_64.sh">https://github.com/Kitware/CMake/releases/download/v3.23.2/cmake-3.23.2-Linux-x86_64.sh</a> and install:</p>
<div class="fragment"><div class="line">chmod +x cmake-3.23.2-Linux-x86_64.sh</div>
<div class="line">sudo mkdir /usr/local/cmake</div>
<div class="line">sudo ./cmake-3.23.2-Linux-x86_64.sh --skip-license --prefix=/usr/local/cmake</div>
</div><!-- fragment --><p>Please ensure <code>/usr/local/cmake/bin</code> is in your <code>PATH</code> environment variable.</p>
<h2><a class="anchor" id="autotoc_md33"></a>
patchelf</h2>
<p>Obtain patchelf from <a href="https://github.com/NixOS/patchelf/releases/download/0.13/patchelf-0.13.tar.bz2">https://github.com/NixOS/patchelf/releases/download/0.13/patchelf-0.13.tar.bz2</a>.</p>
<p>Extract it to a temporary directory using:</p>
<div class="fragment"><div class="line">bzip2 -cd patchelf-0.13.tar.bz2 | tar xvf -</div>
</div><!-- fragment --><p>In the resulting <code>patchelf-0.13.20210805.a949ff2</code> directory, run the:</p>
<div class="fragment"><div class="line">./configure --prefix=/usr/local/gcc103</div>
</div><!-- fragment --><p>script. This should build an appropriate Makefile. Assuming it does, run:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>to complete the build. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
