<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ML C++: Machine Learning Build Machine Setup for Linux</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript" src="../../darkmode_toggle.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../ml.ico"/></td>
  <td id="projectalign">
   <div id="projectname">ML C++<span id="projectnumber">&#160;8.15.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Machine Learning Build Machine Setup for Linux</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md10">OS Packages</a></li>
<li class="level2"><a href="#autotoc_md11">General settings for building the tools</a></li>
<li class="level2"><a href="#autotoc_md12">gcc</a></li>
<li class="level2"><a href="#autotoc_md13">binutils</a></li>
<li class="level2"><a href="#autotoc_md14">Git</a></li>
<li class="level2"><a href="#autotoc_md15">libxml2</a></li>
<li class="level2"><a href="#autotoc_md16">Boost 1.83.0</a></li>
<li class="level2"><a href="#autotoc_md17">patchelf</a></li>
<li class="level2"><a href="#autotoc_md18">CMake</a></li>
<li class="level2"><a href="#autotoc_md19">OpenSSL</a></li>
<li class="level2"><a href="#autotoc_md20">Python 3.10</a></li>
<li class="level2"><a href="#autotoc_md21">Intel MKL</a></li>
<li class="level2"><a href="#autotoc_md22">PyTorch 2.1.2</a></li>
<li class="level2"><a href="#autotoc_md23">valgrind</a></li>
</ul>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="autotoc_md9"></a></p>
<p>These same instructions should work for native compilation on both x86_64 and aarch64 architectures.</p>
<p>To ensure everything is consistent for redistributable builds we build all redistributable components from source with a specific version of gcc.</p>
<p>You will need the following environment variables to be defined:</p>
<ul>
<li><code>JAVA_HOME</code> - Should point to the JDK you want to use to run Gradle.</li>
<li><code>CPP_SRC_HOME</code> - Only required if building the C++ code directly using <code>cmake</code>, as Gradle sets it automatically.</li>
<li><code>PATH</code> - Must have <code>/usr/local/gcc103/bin</code> before <code>/usr/bin</code> and <code>/bin</code>.</li>
<li><code>LD_LIBRARY_PATH</code> - Must have <code>/usr/local/gcc103/lib64</code> and <code>/usr/local/gcc103/lib</code> before <code>/usr/lib</code> and <code>/lib</code>.</li>
</ul>
<p>For example, you might create a <code>.bashrc</code> file in your home directory containing something like this:</p>
<div class="fragment"><div class="line">umask 0002</div>
<div class="line">export JAVA_HOME=/usr/local/jdk1.8.0_121</div>
<div class="line">export LD_LIBRARY_PATH=/usr/local/gcc103/lib64:/usr/local/gcc103/lib:/usr/lib:/lib</div>
<div class="line">export PATH=$JAVA_HOME/bin:/usr/local/gcc103/bin:/usr/local/cmake/bin:/usr/bin:/bin:/usr/sbin:/sbin:/home/vagrant/bin</div>
<div class="line"># Only required if building the C++ code directly using cmake - adjust depending on the location of your Git clone</div>
<div class="line">export CPP_SRC_HOME=$HOME/ml-cpp</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
OS Packages</h2>
<p>You need the C++ compiler and the headers for the <code>zlib</code> library that comes with the OS. You also need the archive utilities <code>unzip</code>, <code>bzip2</code> and <code>xz</code>. <code>libffi-devel</code> and <code>openssl-devel</code> are dependencies for building PyTorch. Finally, the unit tests for date/time parsing require the <code>tzdata</code> package that contains the Linux timezone database. On RHEL/CentOS these can be installed using:</p>
<div class="fragment"><div class="line">sudo yum install bzip2 gcc-c++ libffi-devel openssl-devel texinfo tzdata unzip xz zlib-devel</div>
</div><!-- fragment --><p>On other Linux distributions the package names are generally the same and you just need to use the correct package manager to install these packages.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
General settings for building the tools</h2>
<p>Most of the tools are built via a GNU "configure" script. There are some environment variables that affect the behaviour of this. Therefore, when building ANY tool on Linux, set the following environment variables:</p>
<div class="fragment"><div class="line">export CFLAGS=&#39;-g -O3 -fstack-protector -D_FORTIFY_SOURCE=2 -msse4.2 -mfpmath=sse&#39;</div>
<div class="line">export CXX=&#39;g++ -std=gnu++17&#39;</div>
<div class="line">export CXXFLAGS=&#39;-g -O3 -fstack-protector -D_FORTIFY_SOURCE=2 -msse4.2 -mfpmath=sse&#39;</div>
<div class="line">export LDFLAGS=&#39;-Wl,-z,relro -Wl,-z,now&#39;</div>
<div class="line">export LDFLAGS_FOR_TARGET=&#39;-Wl,-z,relro -Wl,-z,now&#39;</div>
<div class="line">unset LIBRARY_PATH</div>
</div><!-- fragment --><p>For aarch64 replace <code>-msse4.2 -mfpmath=sse</code> with <code>-march=armv8-a+crc+crypto</code>.</p>
<p>These environment variables only need to be set when building tools on Linux. They should NOT be set when compiling the Machine Learning source code (as this should pick up all settings from our build system).</p>
<h2><a class="anchor" id="autotoc_md12"></a>
gcc</h2>
<p>We have to build on old Linux versions to enable our software to run on the older versions of Linux that users have. However, this means the default compiler on our Linux build servers is also very old. To enable use of more modern C++ features, we use the default compiler to build a newer version of gcc and then use that to build all our other dependencies.</p>
<p>Download <code>gcc-10.3.0.tar.gz</code> from <a href="http://ftpmirror.gnu.org/gcc/gcc-10.3.0/gcc-10.3.0.tar.gz">http://ftpmirror.gnu.org/gcc/gcc-10.3.0/gcc-10.3.0.tar.gz</a>.</p>
<p>Unlike most automake-based tools, gcc must be built in a directory adjacent to the directory containing its source code, so build and install it like this:</p>
<div class="fragment"><div class="line">tar zxvf gcc-10.3.0.tar.gz</div>
<div class="line">cd gcc-10.3.0</div>
<div class="line">contrib/download_prerequisites</div>
<div class="line">sed -i -e &#39;s/$(SHLIB_LDFLAGS)/-Wl,-z,relro -Wl,-z,now $(SHLIB_LDFLAGS)/&#39; libgcc/config/t-slibgcc</div>
<div class="line">cd ..</div>
<div class="line">mkdir gcc-10.3.0-build</div>
<div class="line">cd gcc-10.3.0-build</div>
<div class="line">unset CXX</div>
<div class="line">unset LD_LIBRARY_PATH</div>
<div class="line">export PATH=/usr/bin:/bin:/usr/sbin:/sbin</div>
<div class="line">../gcc-10.3.0/configure --prefix=/usr/local/gcc103 --enable-languages=c,c++ --enable-vtable-verify --with-system-zlib --disable-multilib</div>
<div class="line">make -j 6</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>It's important that gcc itself is built using the system compiler in C++98 mode, hence the adjustment to <code>PATH</code> and unsetting of <code>CXX</code> and <code>LD_LIBRARY_PATH</code>.</p>
<p>After the gcc build is complete, if you are going to work through the rest of these instructions in the same shell remember to reset the <code>CXX</code> environment variable so that the remaining C++ components get built with C++17:</p>
<div class="fragment"><div class="line">export CXX=&#39;g++ -std=gnu++17&#39;</div>
</div><!-- fragment --><p>To confirm that everything works correctly run:</p>
<div class="fragment"><div class="line">g++ --version</div>
</div><!-- fragment --><p>It should print:</p>
<div class="fragment"><div class="line">g++ (GCC) 10.3.0</div>
</div><!-- fragment --><p>in the first line of the output. If it doesn't then double check that <code>/usr/local/gcc103/bin</code> is near the beginning of your <code>PATH</code>.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
binutils</h2>
<p>Also due to building on old Linux versions yet wanting to use modern libraries we have to install an up-to-date version of binutils.</p>
<p>Download <code>binutils-2.37.tar.bz2</code> from <a href="http://ftpmirror.gnu.org/binutils/binutils-2.37.tar.bz2">http://ftpmirror.gnu.org/binutils/binutils-2.37.tar.bz2</a>.</p>
<p>Uncompress and untar the resulting file. Then run:</p>
<div class="fragment"><div class="line">./configure --prefix=/usr/local/gcc103 --enable-vtable-verify --with-system-zlib --disable-libstdcxx --with-gcc-major-version-only</div>
</div><!-- fragment --><p>This should build an appropriate Makefile. Assuming it does, type:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>to install.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Git</h2>
<p>Modern versions of Linux will come with Git in their package repositories, and (since we're not redistributing it so don't really care about the exact version used) this is the easiest way to install it. The command will be:</p>
<div class="fragment"><div class="line">sudo yum install git</div>
</div><!-- fragment --><p>on RHEL clones. <b>However</b>, shallow clones do not work correctly before version 1.8.3 of Git, so if the version that yum installs is older you'll still have to build it from scratch. In this case, you may need to uninstall the version that yum installed:</p>
<div class="fragment"><div class="line">git --version</div>
<div class="line">sudo yum remove git</div>
</div><!-- fragment --><p>If you have to build Git from source in order to get version 1.8.3 or above, this is what to do:</p>
<p>Make sure you install the packages <code>python-devel</code>, <code>curl-devel</code> and <code>openssl-devel</code> using yum or similar before you start this.</p>
<p>Start by running:</p>
<div class="fragment"><div class="line">./configure</div>
</div><!-- fragment --><p>as usual.</p>
<p>Then run:</p>
<div class="fragment"><div class="line">make prefix=/usr all</div>
<div class="line">sudo make prefix=/usr install</div>
</div><!-- fragment --><p>Without the <code>prefix=/usr</code> bit, you'll end up with a personal Git build in <code>~/bin</code> instead of one everyone on the machine can use.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
libxml2</h2>
<p>Download <code>libxml2-2.9.14.tar.xz</code> from <a href="https://download.gnome.org/sources/libxml2/2.9/libxml2-2.9.14.tar.xz">https://download.gnome.org/sources/libxml2/2.9/libxml2-2.9.14.tar.xz</a>.</p>
<p>Uncompress and untar the resulting file. Then run:</p>
<div class="fragment"><div class="line">./configure --prefix=/usr/local/gcc103 --without-python --without-readline</div>
</div><!-- fragment --><p>This should build an appropriate Makefile. Assuming it does, type:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>to install.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Boost 1.83.0</h2>
<p>Download version 1.83.0 of Boost from <a href="https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.bz2">https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.bz2</a>. You must get this exact version, as the Machine Learning build system requires it.</p>
<p>Assuming you chose the <code>.bz2</code> version, extract it to a temporary directory:</p>
<div class="fragment"><div class="line">bzip2 -cd boost_1_83_0.tar.bz2 | tar xvf -</div>
</div><!-- fragment --><p>In the resulting <code>boost_1_83_0</code> directory, run:</p>
<div class="fragment"><div class="line">./bootstrap.sh --without-libraries=context --without-libraries=coroutine --without-libraries=graph_parallel --without-libraries=mpi --without-libraries=python --without-icu</div>
</div><!-- fragment --><p>This should build the <code>b2</code> program, which in turn is used to build Boost.</p>
<p>Edit <code>boost/unordered/detail/prime_fmod.hpp</code> and change line 134 from:</p>
<div class="fragment"><div class="line">(13ul)(29ul)(53ul)(97ul)(193ul)(389ul)(769ul)(1543ul)(3079ul)(6151ul)(       \</div>
</div><!-- fragment --><p>to:</p>
<div class="fragment"><div class="line">(3ul)(13ul)(29ul)(53ul)(97ul)(193ul)(389ul)(769ul)(1543ul)(3079ul)(6151ul)(       \</div>
</div><!-- fragment --><p>Finally, run:</p>
<div class="fragment"><div class="line">./b2 -j6 --layout=versioned --disable-icu pch=off optimization=speed inlining=full define=BOOST_MATH_NO_LONG_DOUBLE_MATH_FUNCTIONS define=BOOST_LOG_WITHOUT_DEBUG_OUTPUT define=BOOST_LOG_WITHOUT_EVENT_LOG define=BOOST_LOG_WITHOUT_SYSLOG define=BOOST_LOG_WITHOUT_IPC define=_FORTIFY_SOURCE=2 cxxflags=&#39;-std=gnu++17 -fstack-protector -msse4.2 -mfpmath=sse&#39; cflags=&#39;-D__STDC_FORMAT_MACROS&#39; linkflags=&#39;-std=gnu++17 -Wl,-z,relro -Wl,-z,now&#39;</div>
<div class="line">sudo env PATH=&quot;$PATH&quot; LD_LIBRARY_PATH=&quot;$LD_LIBRARY_PATH&quot; ./b2 install --prefix=/usr/local/gcc103 --layout=versioned --disable-icu pch=off optimization=speed inlining=full define=BOOST_MATH_NO_LONG_DOUBLE_MATH_FUNCTIONS define=BOOST_LOG_WITHOUT_DEBUG_OUTPUT define=BOOST_LOG_WITHOUT_EVENT_LOG define=BOOST_LOG_WITHOUT_SYSLOG define=BOOST_LOG_WITHOUT_IPC define=_FORTIFY_SOURCE=2 cxxflags=&#39;-std=gnu++17 -fstack-protector -msse4.2 -mfpmath=sse&#39; cflags=&#39;-D__STDC_FORMAT_MACROS&#39; linkflags=&#39;-std=gnu++17 -Wl,-z,relro -Wl,-z,now&#39;</div>
</div><!-- fragment --><p>to install the Boost headers and libraries. (Note the <code>env PATH="$PATH"</code> bit in the install command - this is because <code>sudo</code> usually resets <code>PATH</code> and that will cause Boost to rebuild everything again with the default compiler as part of the install!)</p>
<p>For aarch64 replace <code>-msse4.2 -mfpmath=sse</code> with <code>-march=armv8-a+crc+crypto</code>.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
patchelf</h2>
<p>Obtain patchelf from <a href="https://github.com/NixOS/patchelf/releases/download/0.13/patchelf-0.13.tar.bz2">https://github.com/NixOS/patchelf/releases/download/0.13/patchelf-0.13.tar.bz2</a>.</p>
<p>Extract it to a temporary directory using:</p>
<div class="fragment"><div class="line">bzip2 -cd patchelf-0.13.tar.bz2 | tar xvf -</div>
</div><!-- fragment --><p>In the resulting <code>patchelf-0.13.20210805.a949ff2</code> directory, run the:</p>
<div class="fragment"><div class="line">./configure --prefix=/usr/local/gcc103</div>
</div><!-- fragment --><p>script. This should build an appropriate Makefile. Assuming it does, run:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>to complete the build.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
CMake</h2>
<p>CMake version 3.19.2 is the minimum required to build ml-cpp. Download version 3.23.2 from <a href="https://github.com/Kitware/CMake/releases/download/v3.23.2/cmake-3.23.2-Linux-x86_64.sh">https://github.com/Kitware/CMake/releases/download/v3.23.2/cmake-3.23.2-Linux-x86_64.sh</a> and install:</p>
<div class="fragment"><div class="line">chmod +x cmake-3.23.2-Linux-x86_64.sh</div>
<div class="line">sudo mkdir /usr/local/cmake</div>
<div class="line">sudo ./cmake-3.23.2-Linux-x86_64.sh --skip-license --prefix=/usr/local/cmake</div>
</div><!-- fragment --><p>Please ensure <code>/usr/local/cmake/bin</code> is in your <code>PATH</code> environment variable.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
OpenSSL</h2>
<p>Python 3.10 requires OpenSSL 1.1.1. No other version is acceptable.</p>
<p>If the <code>openssl-devel</code> package for your distribution happens to be version 1.1.1 then you can skip this step. Otherwise, you need to build OpenSSL 1.1.1 from source.</p>
<p>Download <code>openssl-1.1.1q.tar.gz</code> from <a href="https://www.openssl.org/source/old/1.1.1/openssl-1.1.1q.tar.gz">https://www.openssl.org/source/old/1.1.1/openssl-1.1.1q.tar.gz</a>, then build as follows:</p>
<div class="fragment"><div class="line">tar zxvf openssl-1.1.1q.tar.gz</div>
<div class="line">cd openssl-1.1.1q</div>
<div class="line">./Configure --prefix=/usr/local/gcc103 shared linux-`uname -m`</div>
<div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md20"></a>
Python 3.10</h2>
<p>PyTorch currently requires Python 3.7 or higher; we use version 3.10. If your system does not have a requisite version of Python install it with a package manager or build the last 3.10 release from source by downloading <code>Python-3.10.9.tgz</code> from <a href="https://www.python.org/ftp/python/3.10.9/Python-3.10.9.tgz">https://www.python.org/ftp/python/3.10.9/Python-3.10.9.tgz</a> then extract as follows:</p>
<div class="fragment"><div class="line">tar xzf Python-3.10.9.tgz</div>
<div class="line">cd Python-3.10.9</div>
</div><!-- fragment --><p>If the distribution you are building on uses OpenSSL 1.1.1 as its built in OpenSSL version then configure as follows:</p>
<div class="fragment"><div class="line">./configure --prefix=/usr/local/gcc103 --enable-optimizations</div>
</div><!-- fragment --><p>If you had to build OpenSSL 1.1.1 yourself then on x86_64 configure like this:</p>
<div class="fragment"><div class="line">sed -i -e &#39;s~ssldir/lib~ssldir/lib64~&#39; configure</div>
<div class="line">./configure --prefix=/usr/local/gcc103 --enable-optimizations --with-openssl=/usr/local/gcc103 --with-openssl-rpath=/usr/local/gcc103/lib64</div>
</div><!-- fragment --><p>or on aarch64 configure like this:</p>
<div class="fragment"><div class="line">./configure --prefix=/usr/local/gcc103 --enable-optimizations --with-openssl=/usr/local/gcc103 --with-openssl-rpath=/usr/local/gcc103/lib</div>
</div><!-- fragment --><p>Finally, build as follows:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make altinstall</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md21"></a>
Intel MKL</h2>
<p>Skip this step if you are building on aarch64.</p>
<p>Intel Maths Kernel Library is an optimized BLAS library which greatly improves the performance of PyTorch CPU inference when PyTorch is built with it.</p>
<div class="fragment"><div class="line">tee &gt; /tmp/oneAPI.repo &lt;&lt; EOF</div>
<div class="line">[oneAPI]</div>
<div class="line">name=Intel oneAPI repository</div>
<div class="line">baseurl=https://yum.repos.intel.com/oneapi</div>
<div class="line">enabled=1</div>
<div class="line">gpgcheck=1</div>
<div class="line">repo_gpgcheck=1</div>
<div class="line">gpgkey=https://yum.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB</div>
<div class="line">EOF</div>
<div class="line">sudo cp /tmp/oneAPI.repo /etc/yum.repos.d</div>
<div class="line">sudo yum -y install intel-oneapi-mkl-devel-2024.0</div>
</div><!-- fragment --><p>The process is different for distributions that use other package managers, for example APT. More instructions can be found at: <a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl-download.html?operatingsystem=linux">https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl-download.html?operatingsystem=linux</a></p>
<p>Then copy the shared libraries to the system directory:</p>
<div class="fragment"><div class="line">(cd /opt/intel/oneapi/mkl/2024.0 &amp;&amp; tar cf - lib) | (cd /usr/local/gcc103 &amp;&amp; sudo tar xvf -)</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md22"></a>
PyTorch 2.1.2</h2>
<p>(This step requires a reasonable amount of memory. It failed on a machine with 8GB of RAM. It succeeded on a 16GB machine. You can specify the number of parallel jobs using environment variable MAX_JOBS. Lower number of jobs will reduce memory usage.)</p>
<p>PyTorch requires that certain Python modules are installed. Install these modules with <code>pip</code> using the same Python version you will build PyTorch with. If you followed the instructions above and built Python from source use <code>python3.10</code>:</p>
<div class="fragment"><div class="line">sudo /usr/local/gcc103/bin/python3.10 -m pip install install numpy ninja pyyaml setuptools cffi typing_extensions future six requests dataclasses</div>
</div><!-- fragment --><p>For aarch64 the <code>ninja</code> module is not available, so use:</p>
<div class="fragment"><div class="line">sudo /usr/local/gcc103/bin/python3.10 -m pip install install numpy pyyaml setuptools cffi typing_extensions future six requests dataclasses</div>
</div><!-- fragment --><p>Then obtain the PyTorch code:</p>
<div class="fragment"><div class="line">git clone --depth=1 --branch=v2.1.2 git@github.com:pytorch/pytorch.git</div>
<div class="line">cd pytorch</div>
<div class="line">git submodule sync</div>
<div class="line">git submodule update --init --recursive</div>
</div><!-- fragment --><p>Edit <code>torch/csrc/jit/codegen/fuser/cpu/fused_kernel.cpp</code> and replace all occurrences of <code>system(</code> with <code>strlen(</code>. This file is used to compile fused CPU kernels, which we do not expect to be doing and never want to do for security reasons. Replacing the calls to <code>system()</code> ensures that a heuristic virus scanner looking for potentially dangerous function calls in our shipped product will not encounter these functions that run external processes.</p>
<p>Build as follows:</p>
<div class="fragment"><div class="line">[ $(uname -m) = x86_64 ] &amp;&amp; export BLAS=MKL || export BLAS=Eigen</div>
<div class="line">export BUILD_TEST=OFF</div>
<div class="line">[ $(uname -m) = x86_64 ] &amp;&amp; export BUILD_CAFFE2=OFF</div>
<div class="line">[ $(uname -m) != x86_64 ] &amp;&amp; export USE_FBGEMM=OFF</div>
<div class="line">[ $(uname -m) != x86_64 ] &amp;&amp; export USE_KINETO=OFF</div>
<div class="line">[ $(uname -m) = x86_64 ] &amp;&amp; export USE_NUMPY=OFF</div>
<div class="line">export USE_DISTRIBUTED=OFF</div>
<div class="line">export USE_MKLDNN=ON</div>
<div class="line">export USE_QNNPACK=OFF</div>
<div class="line">export USE_PYTORCH_QNNPACK=OFF</div>
<div class="line">[ $(uname -m) = x86_64 ] &amp;&amp; export USE_XNNPACK=OFF</div>
<div class="line">export PYTORCH_BUILD_VERSION=2.1.2</div>
<div class="line">export PYTORCH_BUILD_NUMBER=1</div>
<div class="line">/usr/local/gcc103/bin/python3.10 setup.py install</div>
</div><!-- fragment --><p>Once built copy headers and libraries to system directories:</p>
<div class="fragment"><div class="line">sudo mkdir -p /usr/local/gcc103/include/pytorch</div>
<div class="line">sudo cp -r torch/include/* /usr/local/gcc103/include/pytorch/</div>
<div class="line">sudo cp torch/lib/libtorch_cpu.so /usr/local/gcc103/lib</div>
<div class="line">sudo cp torch/lib/libc10.so /usr/local/gcc103/lib</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md23"></a>
valgrind</h2>
<p><code>valgrind</code> is not required to build the code. However, since we build <code>gcc</code> ourselves, if you want to debug with <code>valgrind</code> then you'll get better results if you build a version that's compatible with our <code>gcc</code> instead of using the version you can get via your package manager.</p>
<p>If you find yourself needing to do this, download <code>valgrind</code> from <a href="http://valgrind.org/downloads/">http://valgrind.org/downloads/</a> - the download file will be <code>valgrind-3.17.0.tar.bz2</code>.</p>
<p>Extract it to a temporary directory using:</p>
<div class="fragment"><div class="line">tar jxvf valgrind-3.17.0.tar.bz2</div>
</div><!-- fragment --><p>In the resulting <code>valgrind-3.17.0</code> directory, run:</p>
<div class="fragment"><div class="line">unset CFLAGS</div>
<div class="line">unset CXXFLAGS</div>
<div class="line">./configure --prefix=/usr/local/gcc103 --disable-dependency-tracking --enable-only64bit</div>
</div><!-- fragment --><p>The reason for unsetting the compiler flags is that <code>valgrind</code> does not build correctly with the fortified options we have to use for libraries we ship.</p>
<p>This should build an appropriate Makefile. Assuming it does, run:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">sudo make install</div>
</div><!-- fragment --><p>to complete the build. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
