<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ML C++: Machine Learning Build Machine Setup for macOS</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript" src="../../darkmode_toggle.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="../../ml.ico"/></td>
  <td id="projectalign">
   <div id="projectname">ML C++<span id="projectnumber">&#160;8.15.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Machine Learning Build Machine Setup for macOS</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><ul><li class="level2"><a href="#autotoc_md35">General settings for building the tools</a></li>
<li class="level2"><a href="#autotoc_md36">Xcode</a></li>
<li class="level2"><a href="#autotoc_md37">Boost 1.83.0</a></li>
<li class="level2"><a href="#autotoc_md38">CMake</a></li>
<li class="level2"><a href="#autotoc_md39">Python 3.10</a></li>
<li class="level2"><a href="#autotoc_md40">PyTorch 2.1.2</a></li>
</ul>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="autotoc_md34"></a></p>
<p>These same instructions should work for native compilation on both x86_64 and aarch64 architectures.</p>
<p>To ensure everything is consistent for redistributable builds we build all redistributable components from source.</p>
<p>NOTE: if you upgrade macOS then Xcode may need to be re-installed. Please ensure your Xcode is still valid after upgrades.</p>
<p>You will need the following environment variables to be defined:</p>
<ul>
<li><code>JAVA_HOME</code> - Should point to the JDK you want to use to run Gradle.</li>
<li><code>CPP_SRC_HOME</code> - Only required if building the C++ code directly using <code>cmake</code>, as Gradle sets it automatically.</li>
<li><code>PATH</code> - Must have <code>/usr/local/bin</code> before <code>/usr/bin</code> and <code>/bin</code>.</li>
</ul>
<p>For example, you might create a <code>.bashrc</code> file in your home directory containing something like this:</p>
<div class="fragment"><div class="line">umask 0002</div>
<div class="line">export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk-17.0.1.jdk/Contents/Home</div>
<div class="line">export PYTHONHOME=/Library/Frameworks/Python.framework/Versions/3.10</div>
<div class="line">export PATH=$JAVA_HOME/bin:$PYTHONHOME/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</div>
<div class="line"># Only required if building the C++ code directly using cmake - adjust depending on the location of your Git clone</div>
<div class="line">export CPP_SRC_HOME=$HOME/ml-cpp</div>
</div><!-- fragment --><p>Note, that bash doesn't read <code>~/.bashrc</code> for login shells (which is what you get when you open a new Terminal window) - it reads <code>~/.bash_profile</code> or <code>~/.profile</code> so you should probably also create a <code>.bash_profile</code> file in your home directory which sources <code>.bashrc</code>.</p>
<h2><a class="anchor" id="autotoc_md35"></a>
General settings for building the tools</h2>
<p>Some tools may be built via a GNU "configure" script. There are some environment variables that affect the behaviour of this. Therefore, when building ANY tool on macOS, set the following environment variables:</p>
<div class="fragment"><div class="line">export SSEFLAGS=`[ $(uname -m) = x86_64 ] &amp;&amp; echo -msse4.2`</div>
<div class="line">export CPP=&#39;clang -E&#39;</div>
<div class="line">export CC=clang</div>
<div class="line">export CFLAGS=&quot;-O3 $SSEFLAGS&quot;</div>
<div class="line">export CXX=&#39;clang++ -std=c++17 -stdlib=libc++&#39;</div>
<div class="line">export CXXFLAGS=&quot;-O3 $SSEFLAGS&quot;</div>
<div class="line">export CXXCPP=&#39;clang++ -std=c++17 -E&#39;</div>
<div class="line">export LDFLAGS=-Wl,-headerpad_max_install_names</div>
<div class="line">unset CPATH</div>
<div class="line">unset C_INCLUDE_PATH</div>
<div class="line">unset CPLUS_INCLUDE_PATH</div>
<div class="line">unset LIBRARY_PATH</div>
</div><!-- fragment --><p>The above environment variables only need to be set when building tools on macOS. They should NOT be set when compiling the Machine Learning source code (as this should pick up all settings from our build system).</p>
<h2><a class="anchor" id="autotoc_md36"></a>
Xcode</h2>
<p>The first major piece of development software to install is Apple's development environment, Xcode, which can be downloaded from <a href="https://developer.apple.com/download/">https://developer.apple.com/download/</a> . You will need to register as a developer with Apple. Alternatively, you can get the latest version of Xcode from the App Store.</p>
<ul>
<li>If you are using Big Sur, you must install Xcode 13.2.x</li>
<li>If you are using Monterey, you must install Xcode 14.2.x</li>
<li>If you are using Ventura, you must install Xcode 15.2.x</li>
<li>If you are using Sonoma, you must install Xcode 15.2.x or above</li>
</ul>
<p>Xcode is distributed as a <code>.xip</code> file; simply double click the <code>.xip</code> file to expand it, then drag <code>Xcode.app</code> to your <code>/Applications</code> directory. (Older versions of Xcode can be downloaded from <a href="https://developer.apple.com/download/more/">here</a>, provided you are signed in with your Apple ID.)</p>
<p>There are no command line tools out-of-the-box, so you'll need to install them following installation of Xcode. You can do this by running:</p>
<div class="fragment"><div class="line">xcode-select --install</div>
</div><!-- fragment --><p>at the command prompt.</p>
<h2><a class="anchor" id="autotoc_md37"></a>
Boost 1.83.0</h2>
<p>Download version 1.83.0 of Boost from <a href="https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.bz2">https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.tar.bz2</a>. You must get this exact version, as the Machine Learning build system requires it.</p>
<p>Assuming you chose the <code>.bz2</code> version, extract it to a temporary directory:</p>
<div class="fragment"><div class="line">bzip2 -cd boost_1_83_0.tar.bz2 | tar xvf -</div>
</div><!-- fragment --><p>In the resulting <code>boost_1_83_0</code> directory, run:</p>
<div class="fragment"><div class="line">./bootstrap.sh --with-toolset=clang --without-libraries=context --without-libraries=coroutine --without-libraries=graph_parallel --without-libraries=mpi --without-libraries=python --without-icu</div>
</div><!-- fragment --><p>This should build the <code>b2</code> program, which in turn is used to build Boost.</p>
<p>Edit <code>boost/unordered/detail/prime_fmod.hpp</code> and change line 134 from</p>
<div class="fragment"><div class="line">(13ul)(29ul)(53ul)(97ul)(193ul)(389ul)(769ul)(1543ul)(3079ul)(6151ul)(       \</div>
</div><!-- fragment --><p>to:</p>
<div class="fragment"><div class="line">(3ul)(13ul)(29ul)(53ul)(97ul)(193ul)(389ul)(769ul)(1543ul)(3079ul)(6151ul)(       \</div>
</div><!-- fragment --><p>To complete the build, type:</p>
<div class="fragment"><div class="line">./b2 -j8 --layout=versioned --disable-icu cxxflags=&quot;-std=c++17 -stdlib=libc++ $SSEFLAGS&quot; linkflags=&quot;-std=c++17 -stdlib=libc++ -Wl,-headerpad_max_install_names&quot; optimization=speed inlining=full define=BOOST_MATH_NO_LONG_DOUBLE_MATH_FUNCTIONS define=BOOST_LOG_WITHOUT_DEBUG_OUTPUT define=BOOST_LOG_WITHOUT_EVENT_LOG define=BOOST_LOG_WITHOUT_SYSLOG define=BOOST_LOG_WITHOUT_IPC</div>
<div class="line">sudo ./b2 install --layout=versioned --disable-icu cxxflags=&quot;-std=c++17 -stdlib=libc++ $SSEFLAGS&quot; linkflags=&quot;-std=c++17 -stdlib=libc++ -Wl,-headerpad_max_install_names&quot; optimization=speed inlining=full define=BOOST_MATH_NO_LONG_DOUBLE_MATH_FUNCTIONS define=BOOST_LOG_WITHOUT_DEBUG_OUTPUT define=BOOST_LOG_WITHOUT_EVENT_LOG define=BOOST_LOG_WITHOUT_SYSLOG define=BOOST_LOG_WITHOUT_IPC</div>
</div><!-- fragment --><p>to install the Boost headers and libraries.</p>
<h2><a class="anchor" id="autotoc_md38"></a>
CMake</h2>
<p>CMake version 3.19.2 is the minimum required to build ml-cpp. Download the graphical installer for version 3.23.2 from <a href="https://github.com/Kitware/CMake/releases/download/v3.23.2/cmake-3.23.2-macos-universal.dmg">https://github.com/Kitware/CMake/releases/download/v3.23.2/cmake-3.23.2-macos-universal.dmg</a> (or get a more recent version).</p>
<p>Open the <code>.dmg</code> and install the application it by dragging it to the <code>Applications</code> folder.</p>
<p>Then make the <code>cmake</code> program accessible to programs that look in <code>/usr/local/bin</code>:</p>
<div class="fragment"><div class="line">sudo mkdir -p /usr/local/bin</div>
<div class="line">sudo ln -s /Applications/CMake.app/Contents/bin/cmake /usr/local/bin/cmake</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md39"></a>
Python 3.10</h2>
<p>PyTorch currently requires Python 3.7 or higher; we use version 3.10.</p>
<p>Download the graphical installer for Python 3.10.9 from <a href="https://www.python.org/ftp/python/3.10.9/python-3.10.9-macos11.pkg">https://www.python.org/ftp/python/3.10.9/python-3.10.9-macos11.pkg</a>.</p>
<p>Install using all the default options. When the installer completes a Finder window pops up. Double click the <code>Install Certificates.command</code> file in this folder to install the SSL certificates Python needs.</p>
<h2><a class="anchor" id="autotoc_md40"></a>
PyTorch 2.1.2</h2>
<p>PyTorch requires that certain Python modules are installed. To install them:</p>
<div class="fragment"><div class="line">sudo /Library/Frameworks/Python.framework/Versions/3.10/bin/pip3.10 install install numpy ninja pyyaml setuptools cffi typing_extensions future six requests dataclasses</div>
</div><!-- fragment --><p>Then obtain the PyTorch code:</p>
<div class="fragment"><div class="line">git clone --depth=1 --branch=v2.1.2 https://github.com/pytorch/pytorch.git</div>
<div class="line">cd pytorch</div>
<div class="line">git submodule sync</div>
<div class="line">git submodule update --init --recursive</div>
</div><!-- fragment --><p>Edit <code>torch/csrc/jit/codegen/fuser/cpu/fused_kernel.cpp</code> and replace all occurrences of <code>system(</code> with <code>strlen(</code>. This file is used to compile fused CPU kernels, which we do not expect to be doing and never want to do for security reasons. Replacing the calls to <code>system()</code> ensures that a heuristic virus scanner looking for potentially dangerous function calls in our shipped product will not encounter these functions that run external processes.</p>
<p>Edit <code>tools/setup_helpers/cmake.py</code> and add <code>"DNNL_TARGET_ARCH"</code> to the list of environment variables that get passed through to CMake (around line 215).</p>
<p>For compilation on Apple silicon Macs edit <code>third_party/ideep/include/ideep/utils.hpp</code> and add:</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="keyword">inline</span> <span class="keywordtype">void</span> to_bytes(bytestring&amp; bytes, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> arg) {</div>
<div class="line">  <span class="keyword">auto</span> as_cstring = <span class="keyword">reinterpret_cast&lt;</span><span class="keyword">const </span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(&amp;arg);</div>
<div class="line">  bytes.append(as_cstring, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>));</div>
<div class="line">}</div>
</div><!-- fragment --><p>at around line 189. This is necessary to resolve a template specialization issue.</p>
<p>Build as follows:</p>
<div class="fragment"><div class="line">export BLAS=vecLib</div>
<div class="line">export BUILD_TEST=OFF</div>
<div class="line">export BUILD_CAFFE2=OFF</div>
<div class="line">export USE_NUMPY=OFF</div>
<div class="line">export USE_DISTRIBUTED=OFF</div>
<div class="line">[ $(uname -m) != x86_64 ] &amp;&amp; export DNNL_TARGET_ARCH=AARCH64</div>
<div class="line">export USE_MKLDNN=ON</div>
<div class="line">export USE_QNNPACK=OFF</div>
<div class="line">export USE_PYTORCH_QNNPACK=OFF</div>
<div class="line">[ $(uname -m) = x86_64 ] &amp;&amp; export USE_XNNPACK=OFF</div>
<div class="line">export PYTORCH_BUILD_VERSION=2.1.2</div>
<div class="line">export PYTORCH_BUILD_NUMBER=1</div>
<div class="line">/Library/Frameworks/Python.framework/Versions/3.10/bin/python3.10 setup.py install</div>
</div><!-- fragment --><p>Once built copy headers and libraries to system directories:</p>
<div class="fragment"><div class="line">sudo mkdir -p /usr/local/include/pytorch</div>
<div class="line">sudo cp -r torch/include/* /usr/local/include/pytorch/</div>
<div class="line">sudo cp torch/lib/libtorch_cpu.dylib /usr/local/lib/</div>
<div class="line">sudo cp torch/lib/libc10.dylib /usr/local/lib/</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
